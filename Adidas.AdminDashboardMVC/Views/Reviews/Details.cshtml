 @using Adidas.DTOs.Operation.ReviewDTOs.Query
@model ReviewDto
@{
    ViewData["Title"] = "Review Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Review Details</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard")">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Reviews")">Reviews</a></li>
                    <li class="breadcrumb-item active">Details</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <!-- Review Details -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-star mr-2"></i>Review Information
                        </h3>
                        <div class="card-tools">
                            @{
                                string badgeClass, icon, statusText;

                                if (Model.IsDeleted)
                                {
                                    badgeClass = "badge-dark"; icon = "fas fa-trash"; statusText = "Deleted";
                                }
                                else if (Model.IsApproved)
                                {
                                    badgeClass = "badge-success"; icon = "fas fa-check-circle"; statusText = "Approved";
                                }
                                else if (!Model.IsActive)
                                {
                                    badgeClass = "badge-danger"; icon = "fas fa-times-circle"; statusText = "Rejected";
                                }
                                else
                                {
                                    badgeClass = "badge-warning"; icon = "fas fa-clock"; statusText = "Pending";
                                }
                            }
                            <span class="badge @badgeClass"><i class="@icon"></i> @statusText</span>

                            @* @if (Model.IsVerifiedPurchase) *@
                            @* { *@
                            @*     <span class="badge badge-info ml-2"> *@
                            @*         <i class="fas fa-shield-alt"></i> Verified Purchase *@
                            @*     </span> *@
                            @* } *@
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Rating -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4>Rating</h4>
                                <div class="rating mb-2">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="fas fa-star @(i <= Model.Rating ? "text-warning" : "text-muted")"></i>
                                    }
                                    <span class="ml-2 h5">@Model.Rating.0 out of 5</span>
                                </div>
                            </div>
                        </div>

                        <!-- Review Title -->
                        @if (!string.IsNullOrEmpty(Model.Title))
                        {
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h5>Review Title</h5>
                                    <p class="lead">@Model.Title</p>
                                </div>
                            </div>
                        }

                        <!-- Review Text -->
                        @if (!string.IsNullOrEmpty(Model.ReviewText))
                        {
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5>Review Comment</h5>
                                    <div class="review-content border-left border-primary pl-3">
                                        <p class="text-justify">@Model.ReviewText</p>
                                    </div>
                                </div>
                            </div>
                        }


                        <!-- Permanently Display Rejection Reason for Rejected Reviews -->
                        @if (!Model.IsActive && !string.IsNullOrWhiteSpace(Model.RejectionReason))
                        {
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5>Rejection Reason</h5>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-comment-alt mr-1"></i>
                                        <strong>Reason:</strong> @Model.RejectionReason
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Review Metadata -->
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-calendar mr-2"></i>Created</h6>
                                <p class="text-muted">@Model.CreatedAt.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>

                                @if (!string.IsNullOrEmpty(Model.CreatedBy))
                                {
                                    <h6><i class="fas fa-user mr-2"></i>Created By</h6>
                                    <p class="text-muted">@Model.CreatedBy</p>
                                }
                            </div>
                            <div class="col-md-6">
                                @if (Model.ModifiedAt.HasValue)
                                {
                                    <h6><i class="fas fa-edit mr-2"></i>Last Modified</h6>
                                    <p class="text-muted">@Model.ModifiedAt.Value.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>

                                    @if (!string.IsNullOrEmpty(Model.ModifiedBy))
                                    {
                                        <h6><i class="fas fa-user-edit mr-2"></i>Modified By</h6>
                                        <p class="text-muted">@Model.ModifiedBy</p>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions Card -->
                @if (!Model.IsApproved && Model.IsActive)
                {
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-cogs mr-2"></i>Moderation Actions
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                @* <div class="col-md-6"> *@
                                @*     <button type="button" class="btn btn-success btn-block" id="approveBtn"> *@
                                @*         <i class="fas fa-check mr-2"></i>Approve Review *@
                                @*     </button> *@
                                @* </div> *@
                                @* <div class="col-md-6"> *@
                                @*     <button type="button" class="btn btn-warning btn-block" id="rejectBtn"> *@
                                @*         <i class="fas fa-times mr-2"></i>Reject Review *@
                                @*     </button> *@
                                @* </div> *@
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-12">
                                    <a href="@Url.Action("Index", "Reviews")" class="btn btn-secondary btn-sm ml-2">
                                        <i class="fas fa-arrow-left mr-2"></i>Back to Reviews
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="@(Model.IsApproved ? "text-success" : "text-danger")">
                                <i class="fas @(Model.IsApproved ? "fa-check-circle" : "fa-times-circle") mr-2"></i>
                                This review has been @(Model.IsApproved ? "approved" : "rejected")
                            </h5>
                            <div class="mt-3">
                                <a href="@Url.Action("Index", "Reviews")" class="btn btn-secondary btn-sm ml-2">
                                    <i class="fas fa-arrow-left mr-2"></i>Back to Reviews
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <!-- Customer Info -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-user mr-2"></i>Customer Information
                        </h3>
                    </div>
                    <div class="card-body">
                        
                        <div class="text-center">
                            <h5>Customer ID</h5>
                            <p class="text-muted">@Model.UserId</p>
                            @* <button class="btn btn-info btn-sm" onclick="viewCustomerDetails('@Model.UserId')"> *@
                            @*     <i class="fas fa-eye mr-1"></i>View Profile *@
                            @* </button> *@
                            <a asp-controller="Customers"
                               asp-action="Details"
                               asp-route-id="@Model.UserId"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-eye mr-1"></i>View Profile
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Product Info -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-box mr-2"></i>Product Information
                        </h3>
                    </div>
                    <div class="card-body">
                      
                        <div class="text-center">
                            <h6>Product ID</h6>
                            <p class="text-muted">@Model.ProductId.ToString().Substring(0, 8)...</p>
                            @* <button class="btn btn-info btn-sm" onclick="viewProductDetails('@Model.ProductId')"> *@
                            @*     <i class="fas fa-eye mr-1"></i>View Product *@
                            @* </button> *@
                            <a asp-controller="Products"
                               asp-action="Details"
                               asp-route-id="@Model.ProductId"
                               class="btn btn-info btn-sm">
                                <i class="fas fa-eye mr-1"></i>View Product
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Review Stats -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-bar mr-2"></i>Review Statistics
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="description-block border-right">
                                    <span class="description-percentage text-success">
                                        <i class="fas fa-shield-alt"></i>
                                    </span>
                                    <h5 class="description-header">@(Model.IsVerifiedPurchase ? "Yes" : "No")</h5>
                                    <span class="description-text">Verified Purchase</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="description-block">
                                    <span class="description-percentage text-info">
                                        <i class="fas fa-star"></i>
                                    </span>
                                    <h5 class="description-header">@Model.Rating</h5>
                                    <span class="description-text">Star Rating</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Reject Review</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="rejectForm">
                    <div class="form-group">
                        <label for="rejectReason">Reason for rejection</label>
                        <textarea class="form-control" id="rejectReason" rows="4"
                                  placeholder="Please provide a detailed reason for rejecting this review..." required></textarea>
                        <small class="form-text text-muted">
                            This reason will be logged for audit purposes.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmReject">
                    <i class="fas fa-times mr-2"></i>Reject Review
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const reviewId = '@Model.Id';

            // Event handlers
            $('#approveBtn').click(function() {
                if (confirm('Are you sure you want to approve this review?')) {
                    $.ajax({
                        url: '@Url.Action("Approve", "Reviews")/' + reviewId,
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function(response) {
                            if (response.success) {
                                showToast('success', response.message);
                                setTimeout(() => {
                                    window.location.href = '@Url.Action("Index", "Reviews")';
                                }, 2000);
                            } else {
                                showToast('error', response.message);
                            }
                        },
                        error: function() {
                            showToast('error', 'An error occurred. Please try again.');
                        }
                    });
                }
            });

            $('#rejectBtn').click(function() {
                $('#rejectModal').modal('show');
            });

            $('#confirmReject').click(function() {
                const reason = $('#rejectReason').val().trim();
                if (!reason) {
                    showToast('error', 'Please provide a reason for rejection.');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("Reject", "Reviews")/' + reviewId,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ reason: reason }),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        $('#rejectModal').modal('hide');
                        if (response.success) {
                            showToast('success', response.message);
                            // Reload the current page to show the rejection reason
                            setTimeout(() => {
                                window.location.reload();
                            }, 200);
                        } else {
                            showToast('error', response.message);
                        }
                    },
                    error: function() {
                        $('#rejectModal').modal('hide');
                        showToast('error', 'An error occurred while rejecting the review.');
                    }
                });
            });

            function showToast(type, message) {
                Prevent showing the rejection reason as a toast
                if (message.includes('Reason:') || message === '@Model.RejectionReason') {
                    return;
                }

                const toastClass = {
                    'success': 'alert-success',
                    'error': 'alert-danger',
                    'warning': 'alert-warning',
                    'info': 'alert-info'
                }[type] || 'alert-info';

                const toast = $(`
                    <div class="alert ${toastClass} alert-dismissible fade show position-fixed"
                         style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                        ${message}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `);

                $('body').append(toast);

                setTimeout(() => {
                    toast.alert('close');
                }, 600);
            }
        });

        //           function viewCustomerDetails(customerId) {
        //     window.location.href = '@Url.Action("Details", "Customers", new { id = "__id__" })'.replace('__id__', customerId);
        // }

        //         function viewProductDetails(productId) {
        //     window.location.href = '@Url.Action("Details", "Products", new { id = "__id__" })'.replace('__id__', productId);
        // }
                function viewCustomerDetails(customerId) {
            window.location.href = '@Url.Action("Details", "Customers")' + '/' + customerId;
        }
                function viewProductDetails(productId) {
            window.location.href = '@Url.Action("Details", "Products")' + '/' + productId;
        }



    </script>

    @Html.AntiForgeryToken()
}

<style>
    .rating .fa-star {
        font-size: 1.5rem;
        margin-right: 2px;
    }

    .review-content {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
    }

    .description-block {
        margin-bottom: 10px;
    }

    .description-header {
        margin: 5px 0;
        font-weight: bold;
    }

    .description-text {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .description-percentage {
        font-size: 1.5rem;
        display: block;
        margin-bottom: 5px;
    }
</style>