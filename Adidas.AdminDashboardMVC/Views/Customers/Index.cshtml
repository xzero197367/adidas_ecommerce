@using Adidas.DTOs.Common_DTOs
@using Adidas.DTOs.People.Customer_DTOs
<!-- Views/Customers/Index.cshtml -->
@model PagedResult<CustomerDto>
@{
    ViewData["Title"] = "All Customers";
    var filter = ViewBag.CurrentFilter as CustomerFilterDto ?? new CustomerFilterDto();
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">All Customers</h1>
                <p class="text-muted">Manage customer accounts and memberships</p>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-7">
                        <div class="form-group">
                            <label>Search</label>
                            <input type="text" id="searchInput" class="form-control" placeholder="Search by name or email..." value="@filter.Search">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Status</label>
                            <select id="statusFilter" class="form-control">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>&nbsp;</label><br>
                            <button type="button" id="applyFilters" class="btn btn-dark btn-block">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 text-right">
                        <button type="button" id="exportBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body p-0" id="customerListContainer">
                @await Html.PartialAsync("_CustomerListPartial", Model)
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Set initial filter values
            $('#statusFilter').val('@filter.Status');

            // Apply filters
            $('#applyFilters').click(function() {
                applyFilters();
            });

            // Search on enter
            $('#searchInput').keypress(function(e) {
                if (e.which == 13) {
                    applyFilters();
                }
            });

            // Export functionality
            $('#exportBtn').click(function() {
                var params = getFilterParams();
                window.location.href = '@Url.Action("Export")?' + params;
            });

            // Toggle status
            $(document).on('click', '.toggle-status', function() {
                var customerId = $(this).data('id');

                $.post('@Url.Action("ToggleStatus")', { id: customerId })
                    .done(function(response) {
                        if (response.success) {
                            toastr.success(response.message);
                            applyFilters();
                        } else {
                            toastr.error(response.message);
                        }
                    })
                    .fail(function() {
                        toastr.error('An error occurred while updating the customer status.');
                    });
            });

            // Delete customer
            $(document).on('click', '.delete-customer', function() {
                var customerId = $(this).data('id');
                var customerName = $(this).data('name');

                if (confirm('Are you sure you want to delete customer "' + customerName + '"?')) {
                    $.post('@Url.Action("Delete")', { id: customerId })
                        .done(function(response) {
                            if (response.success) {
                                toastr.success(response.message);
                                applyFilters();
                            } else {
                                toastr.error(response.message);
                            }
                        })
                        .fail(function() {
                            toastr.error('An error occurred while deleting the customer.');
                        });
                }
            });

            // Pagination
            $(document).on('click', '.pagination a', function(e) {
                e.preventDefault();
                var url = $(this).attr('href');
                if (url && url !== '#') {
                    loadCustomers(url);
                }
            });
        });

        function applyFilters() {
            var params = getFilterParams();
            loadCustomers('@Url.Action("GetCustomersData")?' + params);
        }

        function getFilterParams() {
            return $.param({
                search: $('#searchInput').val(),
                membershipTier: $('#membershipFilter').val(),
                status: $('#statusFilter').val(),
                page: 1
            });
        }

        function loadCustomers(url) {
            $('#customerListContainer').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');

            $.get(url)
                .done(function(data) {
                    $('#customerListContainer').html(data);
                })
                .fail(function() {
                    $('#customerListContainer').html('<div class="alert alert-danger">Failed to load customers.</div>');
                });
        }
    </script>
}
